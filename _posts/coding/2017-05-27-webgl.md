---
layout: post
title:  这可能是地球上最美的H5
date:   2017-05-27
categories: coding
tags: Javascript
description: '[知乎]QQX计划推广H5——这可能是地球上最美的H5，是怎么做出来的？'
---

[这可能是地球上最美的H5](https://wa.qq.com/xplan/earth/index.html?_wv=5&_wwv=4&adtag=wx&from=groupmessage)

---

> 作者：[阿舟丶](https://www.zhihu.com/people/flowers1225/answers)
> 链接：https://www.zhihu.com/question/60189741/answer/175296042
> 来源：[知乎-QQX计划推广H5——这可能是地球上最美的H5，是怎么做出来的？](https://www.zhihu.com/question/60189741)
> 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

### 一、关于怎么实现这个地球（星空以及流星实现就不描述了）：

#### 1、地球：

+ 用threejs绘制一个球体，地球的材质选用冯氏（MeshPhongMaterial）因为想创建一个明亮的球体，然后对关照也会有反应，所以选择这种材质。
+ 然后找一个地球的贴图贴上即可（这个地球的贴图颜色方面设计有优化过）

#### 2、凹凸感：      

利用bumpMap贴图以及specularMap贴图来完成。（需要有光照，不然显示不出凹凸感）

#### 3、云层

利用一张云层的png的图来完成（也可以用jpg，不过jpg得对云层进行处理）这里做了两层云来弥补云层稀疏的缺陷。

为了让云层和地球能有个区分，将云层的球体大小设置比地球大1号，不然云层会贴上去。没有层次感。

#### 4、灯光

+ 环境光
+ 聚光灯光（类似手电筒的光，因为只需要照亮地球的某一部分）

tips：这个灯光的感觉完全得靠设计师和开发一起调整了。（推荐gui这个库，调试起立会比较方便）

#### 5、大气层：

首先想到了用一张png的图去做，然而做出来的效果实在是差，所以就飞了。

然后考虑用shader区写一个（threejs支持自定义的shader），同样创建两个球体，一个黑色的球体，一个用材质用shader写的（为了有大气层的效果，这个球体基于原本的球体进行放大一点）。具体的代码就不再这个演示了。      

---

大致这样地球就实现出来了。其中的云层的动画，地球的转动、灯光的颜色、地球的反射强度、大气层的强弱颜色，等等、这些都需要和设计一起花时间进行调试。
      
### 二、点位置的判断和音频的切换。

1、点位置的判断

刚开始的做法：在地球上划分五等分的区域，然后通过射线检测来判断点处于哪个区域来实现区域的划分。（刚开是因为没有点出现在南北极，所以体验上还好，后来产品爸爸说点会出现在南北极，然后这种划分办法在切换相机移动的时候就感觉很奇怪）

改进做法： 反正五个点是固定的，所以通过判断两点距离哪个离的近相机就去哪个地方。这里的两个点是用射线检测与地球相交的点与五个点分别判断得到最近的距离。

2、音频的切换

为了加载所以将5段音频sprite，因为判断出了在离哪个点近，得到那个点的索引值，播放对应的音频就可以了。（视频亦是如此）


### 三、我觉得还可以进行优化：

1. 地球在手指滑动end之后，可以缓动停止。
2. 星空可以考虑做在3d层里，这样在地球刚开始出来的那一瞬间，会感觉整个星空都是转动的。
3. 点位置的设定，因为现在只有5个点，假如产品爸爸说要再加5个点，这5个点的坐标设置会变的很蛋疼，我的想法是可不可以在二维的贴图上描绘出这个点，然后在通过一段转换代码，将这个点转换到3d地球上去（一劳永逸）。
4. 从地球切换到视频那一块的动画，可以考虑用不同的动画描述，而不是单一的云层。
5. 实时的经纬度切换。（现在地球上显示的经纬度是固定的，能实现实时切换可能会帅一点）

---
  
虽然说这个项目并不是那么高大上，但我觉得我已经迈进了webgl的世界了。

附上地球源码供参考：[flowers1225/threejs-earth](https://github.com/flowers1225/threejs-earth)